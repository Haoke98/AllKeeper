{% extends "admin/change_form.html" %}
{% load i18n admin_urls static  admin_modify %}
{% block object-tools %}

    <h1>fuck سادام سادىق</h1>
    <script>
        function getCurDate() {
            var d = new Date();
            var week;
            switch (d.getDay()) {
                case 1:
                    week = "星期一";
                    break;
                case 2:
                    week = "星期二";
                    break;
                case 3:
                    week = "星期三";
                    break;
                case 4:
                    week = "星期四";
                    break;
                case 5:
                    week = "星期五";
                    break;
                case 6:
                    week = "星期六";
                    break;
                default:
                    week = "星期天";
            }
            var years = d.getFullYear();
            var month = add_zero(d.getMonth() + 1);
            var days = add_zero(d.getDate());
            var hours = add_zero(d.getHours());
            var minutes = add_zero(d.getMinutes());
            var seconds = add_zero(d.getSeconds());
            var ndate = years + "年" + month + "月" + days + "日 " + hours + ":" + minutes + ":" + seconds + " " + week;
            divT.innerHTML = ndate;
        }

        function add_zero(temp) {
            if (temp < 10) return "0" + temp;
            else return temp;
        }

        setInterval("getCurDate()", 100);


    </script>

    当前时间：
    <div id="divT"></div>

    <h2>ACCESS_TOKEN:</h2>
    <h2 id="h2_accessToken"></h2>
    <button onclick="getSubcribtionAccessToken()">getAccessToken</button>
    <input>
    <script>
        var access_token = null;
        const xhr = new XMLHttpRequest();

        function getSubcribtionAccessToken() {
            if (access_token == null) {
                var url = "/miniProgram/getSubcribtionAccessToken";
                xhr.open("GET", url, true);
                xhr.send("this is body");
                console.log("已经成功向服务器发送请求，请稍等片刻，你的accesstoken马上就到");
                xhr.onreadystatechange = (e) => {
                    if (xhr.status == 200) {
                        var jsonContent = JSON.parse(xhr.responseText);
                        access_token = jsonContent.access_token;
                        h2_accessToken.innerHTML = access_token;
                    }
                }
            } else {
                alert("access_token已获取过")
            }
        }

        //图片上传
        //上传文件方法
        function UpladFile() {
            var fileObj = document.getElementById("file").files[0]; // js 获取文件对象
            var url = "http://localhost:8080" + "/api/attachment/upload"; // 接收上传文件的后台地址

            var form = new FormData(); // FormData 对象
            form.append("file", fileObj); // 文件对象
            xhr.open("post", url, true); //post方式，url为服务器请求地址，true 该参数规定请求是否异步处理。
            xhr.onload = uploadComplete; //请求完成
            xhr.onerror = uploadFailed; //请求失败
            xhr.upload.onprogress = progressFunction;//【上传进度调用方法实现】
            xhr.upload.onloadstart = function () {//上传开始执行方法
                ot = new Date().getTime();   //设置上传开始时间
                oloaded = 0;//设置上传开始时，以上传的文件大小为0
            };

            xhr.send(form); //开始上传，发送form数据
        }

        //上传成功响应
        function uploadComplete(evt) {
            //服务断接收完文件返回的结果

            var data = JSON.parse(evt.target.responseText);
            if (data.success) {
                alert("上传成功！");
            } else {
                alert("上传失败！");
            }

        }

        //上传失败
        function uploadFailed(evt) {
            alert("上传失败！");
        }

        //取消上传
        function cancleUploadFile() {
            xhr.abort();
        }


        //上传进度实现方法，上传过程中会频繁调用该方法
        function progressFunction(evt) {
            var progressBar = document.getElementById("progressBar");
            var percentageDiv = document.getElementById("percentage");
            // event.total是需要传输的总字节，event.loaded是已经传输的字节。如果event.lengthComputable不为真，则event.total等于0
            if (evt.lengthComputable) {//
                progressBar.max = evt.total;
                progressBar.value = evt.loaded;
                percentageDiv.innerHTML = Math.round(evt.loaded / evt.total * 100) + "%";
            }
            var time = document.getElementById("time");
            var nt = new Date().getTime();//获取当前时间
            var pertime = (nt - ot) / 1000; //计算出上次调用该方法时到现在的时间差，单位为s
            ot = new Date().getTime(); //重新赋值时间，用于下次计算
            var perload = evt.loaded - oloaded; //计算该分段上传的文件大小，单位b
            oloaded = evt.loaded;//重新赋值已上传文件大小，用以下次计算
            //上传速度计算
            var speed = perload / pertime;//单位b/s
            var bspeed = speed;
            var units = 'b/s';//单位名称
            if (speed / 1024 > 1) {
                speed = speed / 1024;
                units = 'k/s';
            }
            if (speed / 1024 > 1) {
                speed = speed / 1024;
                units = 'M/s';
            }
            speed = speed.toFixed(1);
            //剩余时间
            var resttime = ((evt.total - evt.loaded) / bspeed).toFixed(1);
            time.innerHTML = '，速度：' + speed + units + '，剩余时间：' + resttime + 's';
            if (bspeed == 0) time.innerHTML = '上传已取消';
        }
    </script>
    <progress id="progressBar" value="0" max="100" style="width: 300px;"></progress>
    <span id="percentage"></span><span id="time"></span>
    <br/><br/>
    <input type="file" id="file" name="myfile"/>
    <input type="button" οnclick="UpladFile()" value="上传"/>
    <input type="button" οnclick="cancleUploadFile()" value="取消"/>
    <div id="ArticleInfo" style="display: flex;flex-direction:  column">
        <div class="my_dev">
            <label class="my_label" for='article_url'>公众号文章URL:</label>
            <input class="my_input" id='article_url' type="text" onchange="Article_url(value)">
            <input class="my_button" type="button" onClick="getInfoFromUrl('article_url')" value="解析文章链接"/>
        </div>
        <div class="my_dev">
            <label class="my_label">title:</label>
            <input class="my_input" id="articleTitle"/>
            <input class="my_button" type="button" onClick="copy1('articleTitle','value')" value="点击复制标题"/>
        </div>
        <div class="my_dev">
            <label class="my_label">description:</label>
            <input class="my_input" id="description"/>
            <input class="my_button" type="button" onClick="copy1('description','value')" value="点击复制描述"/>
        </div>
        <div class="my_dev">
            <label class="my_label">cover:</label>
            <img class="my_input" id="cover">
            <input class="my_button" type="button" onClick="copy1('cover','src')" value="点击复制图片链接"/>
        </div>
    </div>
    <style>
        .has_filled_automatically {
            color: orange;
        }

        .my_dev {
            display: flex;
        }

        .my_input {
            width: 60%;
            {#height: 10px;#}
            {#max-height: 20px;#}
            {#height: 20%;#}
            margin-right: 1%;
        }

        .my_label {
            width: 20%;
        {#width: 100px;#}

        }

        .my_button {
            width: 20%;
        }
    </style>
    <script>
        function Article_url(value) {
            let element = document.getElementById('article_url');
            element.setAttribute('value', value);
            console.log(value, element);
        }

        function copy1(id, attr) {
            let element = document.getElementById(id);
            copy(element, attr)
        }

        function getInfoFromUrl(id) {
            let element = document.getElementById(id);
            console.log(element);
            let value = element.getAttribute('value');
            console.log(value);
            try {
                document.getElementById('id_url').setAttribute('value', value);
            } catch (e) {

            }
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/miniProgram/getArticleInfo", true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(JSON.stringify({url: value}));
            xhr.onreadystatechange = (e) => {
                if (xhr.status === 200) {
                    console.log(xhr.responseText);
                    json_res = JSON.parse(xhr.responseText);
                    console.log(json_res);
                    let relation =
                        [{id: "articleTitle", attr: "value", json_key: 'title'},
                            {id: "description", attr: "value", json_key: 'description'},
                            {id: 'cover', attr: "src", json_key: 'cover_url'},
                            {id: 'id_title', attr: "value", json_key: 'title'},
                            {id: 'id_name', attr: "value", json_key: 'title'},
                            {id: 'id_description', attr: "value", json_key: 'description'},
                            {id: 'id_cover_url', attr: "value", json_key: 'cover_url'},
                            {id: 'cover', attr: "value", json_key: 'cover_url'}

                        ];
                    for (var i = 0; i < relation.length; i++) {
                        let id = relation[i].id;
                        try {
                            let element = document.getElementById(id);
                            element.setAttribute(relation[i].attr, json_res[relation[i].json_key]);
                            element.setAttribute('class', 'has_filled_automatically '+element.getAttribute('class'));
                        } catch (e) {
                            console.log("fill it failed id:", id, 'error:', e)
                        }
                    }


                    {#var jsonContent = JSON.parse(xhr.responseText);#}
                    {#access_token = jsonContent.access_token;#}
                    {#h2_accessToken.innerHTML = access_token;#}
                }
            }
        }
    </script>
    {% if change %}{% if not is_popup %}
        <ul class="object-tools">
            {% block object-tools-items %}
                {% change_form_object_tools %}
            {% endblock %}
        </ul>
    {% endif %}{% endif %}
{% endblock %}



{% block after_field_sets %}
    <h1>block after_field_sets</h1>
{% endblock %}