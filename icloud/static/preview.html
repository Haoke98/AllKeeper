<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="//unpkg.com/vue@2/dist/vue.js"></script>
    <script src="//unpkg.com/element-ui@2.15.14/lib/index.js"></script>
    <style>
        @import url("//unpkg.com/element-ui@2.15.14/lib/theme-chalk/index.css");
    </style>
</head>
<body>
<div id="app">
    <div style="margin: 20px;">
        <p>ID：{{id}}</p>
    </div>
    <el-tabs type="card">
        <el-tab-pane label="预览">
            <div v-if="isImage(currObj)" style="background-color: black;display: flex;justify-content: center;">
                <el-image v-if="currObj.fields.resJPEGMedRes!==undefined"
                          style="height: 60vh;"
                          :src="currObj.fields.resJPEGMedRes.value.downloadURL"
                          fit="cover"
                          slot="reference"
                ></el-image>
                <el-image v-else-if="currObj.fields.resJPEGThumbRes!==undefined"
                          style="height: 60vh;"
                          :src="currObj.fields.resJPEGThumbRes.value.downloadURL"
                          fit="cover"
                          slot="reference"
                ></el-image>
            </div>
            <div v-else style="background-color: black">
                <video v-if="currObj.fields.resVidSmallRes!==undefined && preview" autoplay controls
                       style="width: 100%;height: 50vh;"
                       loop>
                    <source :src="currObj.fields.resVidSmallRes.value.downloadURL" type="video/mp4">
                </video>
            </div>
        </el-tab-pane>
        <el-tab-pane label="当前MediaObj"><pre style="background-color: #f4f4f4;
                padding: 10px;
                overflow-x: auto;">
            {{ JSON.stringify(currObj, null, 4) }}
        </pre>
        </el-tab-pane>
    </el-tabs>
</div>
<script type="text/javascript">
    new Vue({
        data: {
            id: 0,
            preview: false,
            currObj: {
                recordName: 'AUAAE2ARB3PQpVWZfq9IZeTEIJja',
                recordType: "CPLMaster",
                fields: {
                    resOriginalFileType: {
                        value: 'public.png'
                    },
                    resVidSmallRes: {
                        value: {
                            fileChecksum: "AeAAln07OmMFDhB9NKCPgT+HWqol",
                            size: 325889,
                            wrappingKey: "NEKnQ2TbYUFbxuS9xQBxBQ==",
                            referenceChecksum: "AYhq0FlcezsDWkFqSz2VvC/2mkSe",
                            downloadURL: "https://cvws.icloud-content.com.cn/B/AeAAln07OmMFDhB9NKCPgT-HWqolAYhq0FlcezsDWkFqSz2VvC_2mkSe/${f}?o=Aoa8AIkRQSbqPlpeRi3HBoFF8gBkYb-5ctM1EmAGW1Pf&v=1&x=3&a=CAogkIpMQ_yKh2oU-C46wIY7NjOODrGE9Y9ash_vFEgVJXQSbxCCkt7mqDEYgu-56KgxIgEAUgSHWqolWgT2mkSeaiee0bpVhaZtpnelYU1WuwCH4OovgFka3cfg2njHPkarhnfvw2p1p7pyJ1Prlq2ajBsNH_wAcL6vIlhRrd37W135U6qLWCjPf1RoTMlA7KSSqw&e=1694583650&fl=&r=e535cd07-6aca-4f99-97aa-a862cbdd9bb3-1&k=NEKnQ2TbYUFbxuS9xQBxBQ&ckc=com.apple.photos.cloud&ckz=PrimarySync&y=1&p=215&s=6CExeahUqn2x_q5JJE7OoMMWSVI"
                        },
                        type: "ASSETID"
                    },
                }
            },
            labelPosition: 'right',
        },
        watch: {
            pageSize(newV, oldV) {
                console.log("pageSize:", oldV, newV)
                this.limit = newV * 2
                this.startRank = (this.page - 1) * this.pageSize;
            },
            page(newV, oldV) {
                this.startRank = (this.page - 1) * this.pageSize;
            },
            startRank(newV, oldV) {
                this.getData();
            },
            limit(newV, oldV) {
                this.getData();
            },
            direction(newV, oldV) {
                this.getData();
            },
            smart(newV, oldV) {
                this.getTotal();
                this.getData();
            }
        },
        computed: {
            CPLMaster() {
                let res = [];
                for (const record of this.records) {
                    if (record.recordType === "CPLMaster") {
                        res.push(record)
                    }
                }
                return res;
            },
            CPLAsset() {
                let res = [];
                for (const record of this.records) {
                    if (record.recordType === "CPLAsset") {
                        res.push(record)
                    }
                }
                return res;
            },
            minIndex() {
                return this.offset + 1 - Math.min(this.limit / 2, (this.offset + 1));
            }
        },
        created() {
            this.getTotal();
            this.getData();
        },
        mounted() {
            let queryString = window.location.search;
            let params = new URLSearchParams(queryString);
            this.id = params.get('id'); // 获取name参数的值，结果为"John"
            console.log("iCloud Media ID:", this.id)
        },
        methods: {
            show(record) {
                console.log("clicked:", record,)
                this.currObj = record;
                this.preview = true;
            },
            isImage(record) {
                let image_ext = ['public.jpeg', 'public.png'];
                let res = image_ext.indexOf(record.fields.resOriginalFileType.value) !== -1;
                console.log("isImage:", record, record.fields.resOriginalFileType.value, res)
                try {
                    console.log(currObj.fields.resVidSmallRes, currObj.fields.resVidSmallRes !== undefined)
                } catch (e) {
                    console.log("没有resVidSmallRes字段")
                }
                return res;
            },
            handlePageSizeChange(val) {

            },
            handlePageChange(val) {

            },
            getRank(index) {
                if (this.direction === "ASCENDING") {
                    return this.startRank + index;
                } else {
                    return this.startRank - index;
                }
            },
            getTotal() {
                let _this = this;
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.7)'
                });
                fetch(`http://127.0.0.1:8001/icloud/total?smart=${this.smart}`, {method: "GET",}).then(resp => {
                    console.log("resp:", resp.status, resp.statusText, resp.headers.get("Content-Type"))
                    resp.json().then(respJson => {
                        _this.totalResp = respJson;
                        loading.close();
                    })
                })
            },
            getData() {
                let _this = this;
                console.log(this.offset, this.limit)
                let _url = `http://127.0.0.1:8001/icloud/test?limit=${this.limit}&startRank=${this.startRank}&endRank=${this.endRank}&direction=${this.direction}&smart=${this.smart}`;
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.7)'
                });
                fetch(_url, {method: "GET",}).then(resp => {
                    console.log("resp:", resp.status, resp.statusText, resp.headers.get("Content-Type"))
                    resp.json().then(respJson => {
                        _this.records = respJson.records;
                        loading.close();
                    })
                })
            }
        }
    }).$mount('#app')

</script>
</body>
</html>